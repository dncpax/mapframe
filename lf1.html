<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Leaflet + GeoJSON from variable</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Load Leaflet Geoman from CDN -->
  <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css">
  <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
			width: 100%;
			max-width: 100%;
			max-height: 100%;
    }
  </style>
</head>
<body>

<div id="map"></div>

<script>
// ────────────────────────────────────────────────
//  Your GeoJSON – put whatever you want here
// ────────────────────────────────────────────────
const myGeoJSON = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": [
              -9.446625,
              38.568235
            ]
          },
          "properties": {
            "id": 1,
            "name": "Ponto 0001",
            "category": "escritorio",
            "created_at": "2026-02-01T17:53:26.89577+00:00"
          }
        },
        {
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": [
              -7.78563,
              39.559983
            ]
          },
          "properties": {
            "id": 2,
            "name": "Ponto 0002",
            "category": "escritorio",
            "created_at": "2026-02-01T17:53:26.89577+00:00"
          }
        }
      ]
  };

// ────────────────────────────────────────────────
//  Map setup
// ────────────────────────────────────────────────
const map = L.map('map').setView([39,-7.8], 8);

// Nice free tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);


// ────────────────────────────────────────────────
//  Add the GeoJSON layer
// ────────────────────────────────────────────────
const geoJsonLayer = L.geoJSON(myGeoJSON, {

  // Style function (you can also use an object)
  style: function(feature) {
    return {
      color: feature.properties.stroke || "#3388ff",
      weight: feature.properties["stroke-width"] || 3,
      opacity: 0.85,
      fillOpacity: 0.2
    };
  },

  // Point styling
  pointToLayer: function(feature, latlng) {
    return L.circleMarker(latlng, {
      radius: 8,
      fillColor: "#e74c3c",
      color: "#fff",
      weight: 2,
      opacity: 1,
      fillOpacity: 0.9
    });
  },

  // Popup for every feature that has properties
  onEachFeature: function(feature, layer) {
    /*if (feature.properties && feature.properties.popupContent) {
      layer.bindPopup(feature.properties.popupContent);
    } else */if (feature.properties && feature.properties.name) {
      layer.bindPopup(feature.properties.name);
    }
  }

}).addTo(map);

// add Leaflet-Geoman controls with some options to the map  
map.pm.addControls({  
  drawCircleMarker: false,
  rotateMode: false,
  drawCircle: false,       // customize toolbar
  drawMarker: true,
  drawPolygon: true,
  drawPolyline: false,
  editMode: true,
  dragMode: true,
  removalMode: true
}); 


/*
** GESTOR DE HIGHLIGHT DA SELECAO DE 1 REC
**
**
*/
// Define your highlight styles
const HIGHLIGHT_STYLE = {
  // For polygons / lines
  color: '#00FFFF',     // cyan outline
  weight: 5,
  opacity: 1,
  fillColor: '#FFFF00', // yellow fill
  fillOpacity: 0.5
};

const HIGHLIGHT_POINT_STYLE = {
  radius: 12,
  fillColor: '#FFFF00',     // yellow interior
  color: '#00FFFF',         // cyan outline
  weight: 5,
  opacity: 1,
  fillOpacity: 0.9
};

// Optional: remember original style to restore later
let previouslyHighlighted = null;

function zoomAndHighlightById(id, options = {}) {
  const {
    zoomLevel = 16,           // for points — adjust as needed
    padding = [60, 60],       // pixels — gives some breathing room
    maxZoom = 18,
    duration = 1.2,           // flyTo animation duration (seconds)
    restorePrevious = true    // reset old highlight?
  } = options;

  // 1. Find the layer by id
  let targetLayer = null;

  geojsonLayer.eachLayer(layer => {
    const layerId = layer.feature?.id || layer.feature?.properties?.id || layer._customId;
    if (layerId == id) {           // == so it works with numbers & strings
      targetLayer = layer;
    }
  });

  if (!targetLayer) {
    console.warn(`Feature with id ${id} not found`);
    return;
  }

  // 2. Optional: reset previous highlight
  if (restorePrevious && previouslyHighlighted) {
    // restore original style
    if (previouslyHighlighted.setStyle) {
      previouslyHighlighted.setStyle(previouslyHighlighted.options.origStyle || {});
    } else if (previouslyHighlighted.setRadius) {
      // circle marker
      previouslyHighlighted.setRadius(previouslyHighlighted.options.origRadius || 6);
      previouslyHighlighted.setStyle(previouslyHighlighted.options.origStyle || {});
    }
    previouslyHighlighted = null;
  }

  // 3. Apply highlight style
  if (targetLayer instanceof L.CircleMarker || targetLayer instanceof L.Marker) {
    // Points
    if (!targetLayer.options.origStyle) {
      targetLayer.options.origStyle = { ...targetLayer.options };
      targetLayer.options.origRadius = targetLayer.options.radius;
    }
    targetLayer.setStyle(HIGHLIGHT_POINT_STYLE);
  } else {
    // Polygon / Polyline
    if (!targetLayer.options.origStyle) {
      targetLayer.options.origStyle = { ...targetLayer.options };
    }
    targetLayer.setStyle(HIGHLIGHT_STYLE);
  }

  previouslyHighlighted = targetLayer;

  // 4. Zoom / fly to the feature
  if (targetLayer.getBounds) {
    // Polygon / Line / Multi*
    map.flyToBounds(targetLayer.getBounds(), {
      paddingTopLeft: padding,
      paddingBottomRight: padding,
      duration,
      maxZoom
    });
  } else if (targetLayer.getLatLng) {
    // Point (circleMarker or marker)
    map.flyTo(targetLayer.getLatLng(), zoomLevel, {
      duration,
      animate: true
    });
  }
}


/*
** GESTOR de comms com a parent
**
**
*/
  addEventListener("message", e => {
    console.log('data:' + e.data);
    if (e.source !== parent) return;

    const msg = e.data;
    if (!msg?.type || !msg.id) return;

    const response = { id: msg.id, ok: true };

    const handlers = {
        zoomToPoint: (data) =>{
          zoomAndHighlightById(data.idrec);
        },
        addPoint: (p) => {
            if (!p?.lat || !p?.lng) throw new Error("missing lat/lng");
            console.log("→ add point", p.lat, p.lng);
            const nFeatures = geoJsonLayer.getLayers().length;
             // This is the key line: add one Feature to the existing layer
            geoJsonLayer.addData({
              type: "Feature",
              geometry: {
                type: "Point",
                coordinates: [p.lng, p.lat]          // GeoJSON = [lng, lat] !!!
              },
              properties: {
                id: 9000 + nFeatures +1,
                name: "Ponto " + String(9000 + nFeatures +1).padStart(6, '0'),
                category: "escritorio",
                created_at: new Date().toISOString().replace('Z', '+00:00')
              }
            });
        },

        refreshGeoJSON: (geojson) => {
            if (geojson?.type !== "FeatureCollection") throw new Error("not FeatureCollection");
            console.log("→ refresh geojson", geojson.features.length, "features");
            geoJsonLayer.clearLayers();          // removes all old features
            geoJsonLayer.addData(geojson);
        },

        clear: () => {
            console.log("→ clear map");
            // map.clear();
        },

        setView: ({lat, lng, zoom = 13}) => {
            if (lat == null || lng == null) throw new Error("missing lat/lng");
            console.log("→ set view", lat, lng, "zoom", zoom);
            // map.setView([lat, lng], zoom);
        },

        ping: () => {
            // nothing extra needed
        }
    };

    try {
        const handler = handlers[msg.type];
        if (!handler) {
            response.ok = false;
            response.error = `Unknown command: ${msg.type}`;
        } else {
            handler(msg.payload);
        }
    } catch (err) {
        response.ok = false;
        response.error = err.message;
    }

    parent.postMessage(response, "*");
  });

</script>

</body>
</html>
