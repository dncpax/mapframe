<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenLayers – Paste PostGIS Points GeoJSON</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.5.0/ol.css"> 
  <script src="https://cdn.jsdelivr.net/npm/ol@v10.5.0/dist/ol.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.12.1/proj4.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 100vh; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.35);
      max-width: 380px;
    }
    textarea {
      width: 100%;
      height: 140px;
      font-family: monospace;
      font-size: 13px;
    }
    button {
      margin-top: 8px;
      padding: 6px 12px;
    }
  </style>
	<script>// Define your EPSG:3763 (add this early, e.g. right after map init or before loadGeoJSON)
proj4.defs("EPSG:3763",
  "+proj=tmerc +lat_0=39.6682583333333 +lon_0=-8.13310833333333 +k=1 " +
  "+x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs"
);

// Optional: if you want to be extra sure OpenLayers sees it (rarely needed in global mode)
ol.proj.proj4.register(proj4); </script>
</head>
<body>

<div id="map"></div>

<!--div id="controls">
  <strong>Paste your PostGIS GeoJSON here:</strong><br>
  <textarea id="geojson-input">{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [ -0.1278, 51.5074 ]
      },
      "properties": {
        "name": "Example point A",
        "value": 42
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [ 2.3522, 48.8566 ]
      },
      "properties": {
        "name": "Example point B",
        "value": 17
      }
    }
  ]
}</textarea>
  <br>
  <button onclick="loadGeoJSON()">Load / Update Points</button>
  <p style="font-size:0.9em; color:#555; margin-top:12px;">
    Paste output from <code>ST_AsGeoJSON</code> (FeatureCollection expected)
  </p>
</div-->

<script>
// ┌──────────────────────────────────────────────────────────────┐
// │  Paste your real PostGIS GeoJSON output here                 │
// │  (replace the example data below)                            │
// └──────────────────────────────────────────────────────────────┘
const pastedGeoJSON = {
  "type": "FeatureCollection",
  "features": [{"type" : "Feature", "geometry" : {"crs": {"type": "name", "properties": {"name": "EPSG:3763"}}, "type": "Point", "coordinates": [-114475.762827816, -121303.977365384]}, "properties" : {"id": 1, "name": "Ponto 0001", "category": "escritorio", "created_at": "2026-02-01T17:53:26.89577+00:00"}}, {"type" : "Feature", "geometry" : {"crs": {"type": "name", "properties": {"name": "EPSG:3763"}}, "type": "Point", "coordinates": [29862.112474212, -11963.789814079]}, "properties" : {"id": 2, "name": "Ponto 0002", "category": "escritorio", "created_at": "2026-02-01T17:53:26.89577+00:00"}}]
};

// If you prefer to paste during runtime, leave the object empty and use the textarea
// const pastedGeoJSON = null;   // uncomment if you want to force textarea usage

let vectorLayer;

function loadGeoJSON() {
  let geojson;
  
  // Option A: use hardcoded variable (most convenient for dev)
  if (pastedGeoJSON && pastedGeoJSON.type === 'FeatureCollection') {
    geojson = pastedGeoJSON;
  }
  // Option B: use textarea content (runtime pasting)
  else {
    const input = document.getElementById('geojson-input').value.trim();
    try {
      geojson = JSON.parse(input);
    } catch (e) {
      alert('Invalid GeoJSON:\n' + e.message);
      return;
    }
    if (geojson.type !== 'FeatureCollection') {
      alert('GeoJSON must be a FeatureCollection');
      return;
    }
  }

  const format = new ol.format.GeoJSON();

  const features = format.readFeatures(geojson, {
    dataProjection: 'EPSG:3763',
    featureProjection: 'EPSG:3857'   // OpenLayers default map projection
  });

  // Create or update vector source
  const source = new ol.source.Vector({
    features: features
  });

  // Simple red circle style for points
  const style = new ol.style.Style({
    image: new ol.style.Circle({
      radius: 6,
      fill: new ol.style.Fill({ color: 'rgba(220, 20, 60, 0.9)' }),
      stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
    })
  });

  // Remove old layer if exists
  if (vectorLayer) {
    map.removeLayer(vectorLayer);
  }

  vectorLayer = new ol.layer.Vector({
    source: source,
    style: style
  });

  map.addLayer(vectorLayer);

  // Zoom to the points if any exist
  if (features.length > 0) {
    map.getView().fit(source.getExtent(), {
      padding: [60, 60, 60, 60],
      maxZoom: 15
    });
  }
}

// ────────────────────────────────────────────────
//               MAP INITIALIZATION
// ────────────────────────────────────────────────

const map = new ol.Map({
  target: 'map',
  layers: [
    new ol.layer.Tile({
      source: new ol.source.OSM()
    })
  ],
  view: new ol.View({
    center: ol.proj.fromLonLat([-7.8, 39]),  // rough center of Europe
    zoom: 9
  })
});

// Load initial data on page load (from the variable)
window.onload = () => {
  loadGeoJSON();
}; 
</script>
</body>
</html>
